# ğŸ›ï¸ Saga Choreography íŒ¨í„´ ì•„ì´í…œ êµ¬ë§¤ ì‹œìŠ¤í…œ

NestJSì™€ TypeScriptë¡œ êµ¬í˜„í•œ **Saga Choreography íŒ¨í„´** ê¸°ë°˜ ì•„ì´í…œ êµ¬ë§¤ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” **í•™ìŠµìš©**ìœ¼ë¡œ, ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ íŠ¸ëœì­ì…˜ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ëŠ” Saga Choreography íŒ¨í„´ì„ ì‹¤ì œë¡œ êµ¬í˜„í•´ë³¸ ì˜ˆì œì…ë‹ˆë‹¤.

### ğŸ¯ í•µì‹¬ íŠ¹ì§•

- âœ… **Saga Choreography íŒ¨í„´** - ì¤‘ì•™ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì—†ëŠ” ì´ë²¤íŠ¸ ê¸°ë°˜ ë¶„ì‚° íŠ¸ëœì­ì…˜
- âœ… **ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜** - Redis Pub/Subë¥¼ í™œìš©í•œ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬  
- âœ… **ë³´ìƒ íŠ¸ëœì­ì…˜** - ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°± ì²´ì¸ êµ¬í˜„
- âœ… **ë™ì‹œì„± ì œì–´** - ë¶„ì‚° ë½ì„ í†µí•œ race condition ë°©ì§€
- âœ… **ê°„ê²°í•œ êµ¬í˜„** - í•™ìŠµì— ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ í•µì‹¬ ë¡œì§ë§Œ êµ¬í˜„

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order       â”‚    â”‚ User        â”‚    â”‚ Inventory   â”‚
â”‚ Service     â”‚â”€â”€â”€â–¶â”‚ Service     â”‚â”€â”€â”€â–¶â”‚ Service     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Item        â”‚â—€â”€â”€â”€â”‚ Payment     â”‚â—€â”€â”€â”€â”‚ Notificationâ”‚
â”‚ Service     â”‚    â”‚ Service     â”‚    â”‚ Service     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Redis     â”‚
                  â”‚ Event Bus   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Saga íë¦„

### ì„±ê³µ ì‹œë‚˜ë¦¬ì˜¤ (Happy Path)
1. **Order Service**: ì£¼ë¬¸ ìƒì„± â†’ `OrderCreated` ì´ë²¤íŠ¸ ë°œí–‰
2. **User Service**: ì‚¬ìš©ì/ì”ê³  ê²€ì¦ â†’ `PaymentReserved` ì´ë²¤íŠ¸ ë°œí–‰  
3. **Inventory Service**: ì¸ë²¤í† ë¦¬ ê³µê°„ ì˜ˆì•½ â†’ `InventoryReserved` ì´ë²¤íŠ¸ ë°œí–‰
4. **Item Service**: ì•„ì´í…œ ì¬ê³  ì˜ˆì•½ â†’ `ItemReserved` ì´ë²¤íŠ¸ ë°œí–‰
5. **Payment Service**: ê²°ì œ ì²˜ë¦¬ â†’ `PaymentProcessed` ì´ë²¤íŠ¸ ë°œí–‰
6. **Order Service**: ì£¼ë¬¸ ì™„ë£Œ â†’ `OrderCompleted` ì´ë²¤íŠ¸ ë°œí–‰
7. **Notification Service**: êµ¬ë§¤ ì™„ë£Œ ì•Œë¦¼

### ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ (ë³´ìƒ íŠ¸ëœì­ì…˜)
ì‹¤íŒ¨ ì§€ì ì— ë”°ë¥¸ ìë™ ë¡¤ë°± ì²´ì¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤:

- **User Service ì‹¤íŒ¨** â†’ Order ì·¨ì†Œ
- **Inventory Service ì‹¤íŒ¨** â†’ User ì”ê³  ë¡¤ë°± + Order ì·¨ì†Œ  
- **Item Service ì‹¤íŒ¨** â†’ Inventory í•´ì œ + User ì”ê³  ë¡¤ë°± + Order ì·¨ì†Œ
- **Payment Service ì‹¤íŒ¨** â†’ ì „ì²´ ë¡¤ë°± ì²´ì¸ ì‹¤í–‰

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **Backend**: NestJS + TypeScript
- **Database**: SQLite + TypeORM (ê°„ë‹¨í•œ ë¡œì»¬ ê°œë°œìš©)
- **Event Bus**: Redis (Pub/Sub)
- **Caching**: Redis (ìƒíƒœ ê´€ë¦¬, ë¶„ì‚° ë½)

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. ì˜ì¡´ì„± ì„¤ì¹˜
```bash
npm install
```

### 2. Redis ì‹¤í–‰ (Docker ì‚¬ìš©)
```bash
# Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -d -p 6379:6379 --name redis redis:alpine

# ë˜ëŠ” ë¡œì»¬ Redis ì„¤ì¹˜ í›„ ì‹¤í–‰
redis-server
```

### 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
```bash
# ê°œë°œ ëª¨ë“œ
npm run start:dev

# í”„ë¡œë•ì…˜ ë¹Œë“œ
npm run build
npm run start:prod
```

### 4. Saga íŒ¨í„´ í…ŒìŠ¤íŠ¸
```bash
# ì „ì²´ Saga í”Œë¡œìš° í…ŒìŠ¤íŠ¸
npm run test:saga
```

## ğŸ§ª API í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
```bash
curl -X POST http://localhost:3000/setup-test-data
```

### ì•„ì´í…œ êµ¬ë§¤ (Saga ì‹œì‘)
```bash
curl -X POST http://localhost:3000/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "{ì‚¬ìš©ìID}",
    "itemId": "{ì•„ì´í…œID}", 
    "quantity": 1
  }'
```

### ìƒíƒœ ì¡°íšŒ
```bash
# ì‚¬ìš©ì ì”ê³  í™•ì¸
curl http://localhost:3000/user/{ì‚¬ìš©ìID}/balance

# ì‚¬ìš©ì ì¸ë²¤í† ë¦¬ í™•ì¸  
curl http://localhost:3000/user/{ì‚¬ìš©ìID}/inventory

# ì£¼ë¬¸ ë‚´ì—­ í™•ì¸
curl http://localhost:3000/user/{ì‚¬ìš©ìID}/orders
```

## ğŸ“ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### ì´ë²¤íŠ¸ íƒ€ì…
```typescript
enum EventType {
  ORDER_CREATED = 'order.created',
  USER_VALIDATED = 'user.validated', 
  INVENTORY_RESERVED = 'inventory.reserved',
  ITEM_RESERVED = 'item.reserved',
  PAYMENT_PROCESSED = 'payment.processed',
  ORDER_COMPLETED = 'order.completed',
  // ... ì‹¤íŒ¨ ë° ë¡¤ë°± ì´ë²¤íŠ¸ë“¤
}
```

### í•µì‹¬ ì„œë¹„ìŠ¤ë³„ ì—­í• 
- **OrderService**: Saga ì‹œì‘ì , ì£¼ë¬¸ ìƒíƒœ ê´€ë¦¬
- **UserService**: ì‚¬ìš©ì ê²€ì¦, ì”ê³  ì˜ˆì•½/ë³µì›  
- **InventoryService**: ì¸ë²¤í† ë¦¬ ê³µê°„ ê´€ë¦¬
- **ItemService**: ì•„ì´í…œ ì¬ê³  ê´€ë¦¬
- **PaymentService**: ê²°ì œ ì²˜ë¦¬ (ëª¨ì˜ êµ¬í˜„)
- **NotificationService**: ì•Œë¦¼ (ë¡œê·¸ ì¶œë ¥)

### ë³´ìƒ íŠ¸ëœì­ì…˜ ì˜ˆì œ
```typescript
// User Service - ì”ê³  ë¡¤ë°±
private async rollbackBalance(eventData: any, reason: string) {
  const reservation = await this.eventBus.getReservation(reservationKey);
  user.balance = reservation.originalBalance; // ì›ë˜ ì”ê³ ë¡œ ë³µì›
  await this.userRepository.save(user);
  await this.eventBus.publish(EventType.PAYMENT_ROLLBACK, rollbackEvent);
}
```

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

### 1. Saga Choreography vs Orchestrator
- **Choreography**: ê° ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ì´ë²¤íŠ¸ ë°œí–‰/êµ¬ë… (ë³¸ í”„ë¡œì íŠ¸)
- **Orchestrator**: ì¤‘ì•™ ì¡°ì •ìê°€ ì „ì²´ í”Œë¡œìš° ê´€ë¦¬

### 2. ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜
- ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ê²°í•©
- í™•ì¥ì„±ê³¼ ë³µì›ë ¥ í–¥ìƒ
- ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ê°œì„ 

### 3. ë¶„ì‚° ì‹œìŠ¤í…œ ê³¼ì œë“¤
- **ì¼ê´€ì„±**: ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì–´ì•¼ í•¨
- **ë™ì‹œì„±**: ì—¬ëŸ¬ ìš”ì²­ì´ ë™ì‹œì— ì²˜ë¦¬ë  ë•Œ ì¶©ëŒ ë°©ì§€  
- **ë³µì›ë ¥**: ì¼ë¶€ ì„œë¹„ìŠ¤ ì¥ì•  ì‹œì—ë„ ì‹œìŠ¤í…œ ì „ì²´ ì•ˆì •ì„± ìœ ì§€

### 4. ë³´ìƒ íŠ¸ëœì­ì…˜ ì„¤ê³„
- ê° ë‹¨ê³„ë³„ ë¡¤ë°± ë¡œì§ êµ¬í˜„
- ë©±ë“±ì„±(Idempotency) ë³´ì¥
- ìˆœí™˜ ì˜ì¡´ì„± ë°©ì§€

## âš ï¸ í˜„ì¬ êµ¬í˜„ì˜ í•œê³„ (í•™ìŠµìš©)

- **ì‹¤ì œ PG ì—°ë™ ì—†ìŒ**: ê²°ì œëŠ” ëª¨ì˜ ì²˜ë¦¬ (10% í™•ë¥  ì‹¤íŒ¨)
- **íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ**: ë¬´í•œ ëŒ€ê¸° ë°©ì§€ ë¡œì§ ë¯¸êµ¬í˜„
- **Dead Letter Queue**: ì‹¤íŒ¨ ì´ë²¤íŠ¸ ì¬ì²˜ë¦¬ ë¡œì§ ë¯¸êµ¬í˜„  
- **ê°ì‚¬ ë¡œê·¸**: ìƒì„¸í•œ ì¶”ì  ë¡œê·¸ ì‹œìŠ¤í…œ ë¯¸êµ¬í˜„
- **ë³µì¡í•œ ì¬ê³  ê´€ë¦¬**: ì˜ˆì•½/í• ë‹¹/í™•ì • ë‹¨ê³„ ê°„ì†Œí™”

## ğŸ”§ ì‹¤ì œ í™˜ê²½ ì ìš© ì‹œ ê³ ë ¤ì‚¬í•­

1. **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL/MySQL + ì—°ê²° í’€ë§
2. **ë©”ì‹œì§€ ë¸Œë¡œì»¤**: Apache Kafka, RabbitMQ ë“±  
3. **ëª¨ë‹ˆí„°ë§**: ë¶„ì‚° ì¶”ì  (Jaeger, Zipkin)
4. **ë³´ì•ˆ**: ì¸ì¦/ì¸ê°€, API ê²Œì´íŠ¸ì›¨ì´
5. **í…ŒìŠ¤íŠ¸**: í†µí•© í…ŒìŠ¤íŠ¸, ì¹´ì˜¤ìŠ¤ ì—”ì§€ë‹ˆì–´ë§
6. **ìš´ì˜**: í—¬ìŠ¤ ì²´í¬, ë©”íŠ¸ë¦­ìŠ¤, ì•ŒëŸ¿

## ğŸ“š ì°¸ê³  ìë£Œ

- [Saga Pattern - Microservices.io](https://microservices.io/patterns/data/saga.html)
- [Event Sourcing Pattern](https://martinfowler.com/eaaDev/EventSourcing.html)
- [NestJS Documentation](https://docs.nestjs.com/)

---

ğŸ’¡ **ì´ í”„ë¡œì íŠ¸ëŠ” Saga Choreography íŒ¨í„´ì˜ í•µì‹¬ ê°œë…ì„ ì´í•´í•˜ê¸° ìœ„í•œ í•™ìŠµìš© êµ¬í˜„ì…ë‹ˆë‹¤.**